<html layout:decorate="global/layouts/layout" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" >
<div layout:fragment="content" class="mx-auto ">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5838a85eb793c1ea2258889f7c67b41b"></script>

    <th:block th:fragment="custom-css">
        <style>
            .concert-info {
                display: flex;
                justify-content: space-between;
                margin-top: 50px;
                margin-right: 20px;
            }

            .concert-info2 {
                margin-top: 50px; /* 각 요소 사이의 간격 설정 */
            }

            .concert-info2 span:nth-child(2) {
                margin-left: 20px;
            /
            }

            .concert-info span:nth-child(2) {
                margin-left: 20px;
            }

            #submitButton:disabled {
                background-color: grey; /* 비활성화 상태의 배경색 */
                color: black; /* 비활성화 상태의 텍스트 색상 */
            }


        </style>
    </th:block>

    <div class="artboard artboard-horizontal phone-6  border">
        <div class="artboard artboard-horizontal phone-1  mx-auto">
            <div class="grid h-20 card place-items-center" style="justify-content: flex-start">
                <h2 th:text="${concertDTO.getConcertNameKr()}"></h2>
            </div>

            <div>
                <div class="concert-info">
                    <div>
                        <span>장소 </span><span th:text="${place.getLatitude()}"></span>
                    </div>

                    <div>
                        <span>장르 </span><span th:text="${concertDTO.getCategory()}"></span>
                    </div>
                </div>

                <div class="concert-info2">
                    <span>공연 기간 </span>


                    <!--공연 시작 날짜-->
                    <span th:text="${#temporals.format(concertDateDTO.getFirst().getStartTime(), 'yyyy-MM-dd')}"></span>
                    ~

                    <!--공연 종료 날짜-->
                    <span th:text="${#temporals.format(concertDateDTO.getLast().getEndTime(), 'yyyy-MM-dd')}"></span>

                </div>

            </div>

            <div class="concert-info">
                <div>
                    <span>관람 시간 </span><span th:text="${viewingTime.toMinutes()}"></span>분

                </div>

                <div>
                    <span>가격 </span><span th:text="${concertDTO.getSeatPrice()}"></span>원
                </div>
            </div>

        </div>

    </div>

    <div class="flex flex-col w-full border-opacity-50">

        <div class="flex w-full">
            <div class="grid h-20 flex-grow card place-items-center">

                <select class="select select-bordered select-lg w-full max-w-xs" id="concertDateSelect">
                    <option value="0">예매 일자를 선택해주세요</option>
                    <option th:each="concertDate : ${concertDateDTO}"
                            th:value="${concertDate.concertDateId}"
                            th:utext="${#temporals.format(concertDate.getStartTime(), 'yyyy-MM-dd HH:mm')}"></option>
                </select>

            </div>

            <div class="divider divider-horizontal"></div>

            <div class="grid h-20 flex-grow card place-items-center">

                <div>
                    <form id="seatForm" th:action="|/concert/${concertDTO.concertId}/seat|" method="POST">
                        <input type="hidden" name="concertDateId" value="0">
                        <button id="submitButton" class="bg-blue-500 text-white p-3 rounded-md hover:bg-blue-600 focus:outline-none focus:shadow-outline-blue" type="submit">예매하기</button>

<!--                        <button th:if="${#temporals.isAfter(concertDTO.getReleaseTime(), #temporals.createNow())}" type="button">예매하기</button>-->
<!--                        <button th:unless="${#temporals.isAfter(concertDTO.getReleaseTime(), #temporals.createNow())}" type="button" disabled>예매하기</button>-->
                    </form>
                </div>
            </div>
        </div>
        <div class="divider"></div> <!--중간 라인-->

        <div role="tablist" class="tabs tabs-lifted tabs-lg">
            <input type="radio" name="my_tabs_2" role="tab" class="tab" aria-label="상세정보" />
            <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6 !block invisible">
                <!--출연진 정보 콜랩스 시작 -->
                <details class="collapse bg-base-200">
                    <summary class="collapse-title text-xl font-medium">출연진 정보</summary>
                    <div class="collapse-content">
                        <!--출연진 정보 테이블 시작-->
                        <div class="overflow-x-auto">
                            <table class="table">
                                <!-- head -->
                                <thead>
                                <tr class="text-xl">
                                    <th th:each="performer : ${performers}">Name</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- row 1 -->
                                <tr>   <!--출연진 정보를 한 행으로 출력함-->
                                    <td th:each="perfomer : ${performers}">
                                    <p class="text-xl" th:text="${perfomer.getArtistNameKr()}"></p>
                                    </td>

                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <!--출연진 정보 테이블 끝-->
                    </div>
                </details>
                <!--출연진 정보 콜랩스 끝  -->

                <details class="collapse bg-base-200 mt-3">
                    <summary class="collapse-title text-xl font-medium">공연 시간 </summary>
                    <div class="collapse-content" th:each="concertDate : ${concertDateDTO}">
                        <!-- 공연 시작 시간 -->
                        <span th:text="${#temporals.format(concertDate.startTime, 'yyyy년 MM월 dd일 EEE요일 HH:mm')}"></span>
                        ~
                        <!-- 공연 종료 시간 -->
                        <span th:text="${#temporals.format(concertDate.endTime, 'yyyy년 MM월 dd일 EEE요일 HH:mm')}"></span>

                    </div>
                </details>


                <details class="collapse bg-base-200 mt-3">
                    <summary class="collapse-title text-xl font-medium">예매 공지 사항 </summary>
                    <div class="collapse-content" >
                        <p style="color: #dc0000">※ 티켓 오픈 시간</p>
                        <!--티켓오픈 시간 과 현재시간과 비교 용도 사용자한테 보여서는안됨 ,
                         시간 포맷을 해 버릴 경우 현재시간 포맷형식이 달라 예매하기버튼 비활성화 ,활성화 동작이 안됨 -->
                        <span id="releaseTime" th:text="${concertDTO.getReleaseTime()}" style="display: none;"></span>

                        <!--사용자 에게 보이는 용도 (티켓오픈시간)-->
                        <span  th:text="${#temporals.format(concertDTO.getReleaseTime(), 'yyyy년 MM월 dd일 EEE요일 HH:mm')}"></span>

                        <p class="mt-3" style="color: #dc0000">[ 예매 및 취소 마감 기한 안내 ]</p>
                        <p>티켓 예매, 취소 및 변경, 환불이 불가하오니 유의해주시기 바랍니다. </p>

                    </div>
                </details>


            </div>

            <!--리뷰 작성 탭 시작-->
            <input type="radio" name="my_tabs_2" role="tab" class="tab" aria-label="리뷰"  checked/>
            <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6 !block invisible">

                <!--리뷰 입력창 시작-->
                <div class="mt-20" >
                    <form th:action="@{|/review/${concertDTO.getConcertId()}|}" method="post" onsubmit="submitWriteForm(this); return false;">

                        <textarea class ="textarea textarea-bordered w-full" id="content" name="content"  rows="4" cols="50" placeholder="리뷰를 입력하세요..."></textarea><br>

                        <button class="btn btn-neutral">리뷰 작성</button>
                    </form>
                </div>
                <h5 class="mt-5" th:text="|${reviews.getTotalElements()}개의 답변|"></h5>

                <!--답변 입력창 끝-->
                <div th:each="review  : ${reviews}">
                    <div class="comment-container">
                        <div class="mt-5" style="font-size: small">

                            <span class="mt-3">작성자: <span th:text="${review.getAuthorName()}"></span></span> <!--사용자 이름 으로 작성-->
                            <span>&nbsp;&nbsp;&nbsp;</span>
                            <span>작성일: <span th:text="${#temporals.format(review.getCreatedDate(), 'yyyy-MM-dd HH:mm')}"></span></span>
                            <span>&nbsp;&nbsp;&nbsp;</span>

<!--                             수정 버튼 시작-->
                            <label for="edit-review-modal" class="btn btn-sm edit-review-btn"
                                   onclick="openEditModal(this)"
                                   th:attr="data-review-id=${review.getReviewId()},
                                            data-review-content=${review.getContent()},
                                            data-concert-id=${review.getConcertId()}"
                                   th:href="@{|/review/delete/${review.getReviewId()}|}"
                                   th:if="${#authorization.expression('hasAuthority(''ADMIN'')') or review.getLoginId() != null
                                         and #authentication.getName() == review.getLoginId()}">수정
                                        <i class="fa-solid fa-pen" ></i></label>


                            <input type="checkbox" id="edit-review-modal" class="modal-toggle"/>
                            <div class="modal" role="dialog">
                                <div class="modal-box" >
                                    <form>
<!--                                        <input type="hidden" name="method" value="PATCH">-->
                                        <textarea class ="textarea textarea-bordered w-full" id="edit-review"  rows="4" cols="50" placeholder="리뷰를 입력하세요..." ></textarea><br>
                                        <input type="hidden" id="edit-review-id" th:value="${review.reviewId}">
                                        <input type="hidden" id="edit-review-concert-id" th:value="${review.getConcertId()}">
                                        <div class="modal-action">
                                            <button class="btn btn-neutral" id="edit-Review-btn">리뷰 수정</button>
                                            <label for="edit-review-modal" class="btn">Close!</label>
                                        </div>
                                    </form>
                                </div>
                            </div>
<!--                             수정 버튼 끝 -->

                            <!--삭제 버튼 시작-->
                            <a onclick="return confirm('정말로 삭제하시겠습니까?');" th:href="@{|/review/delete/${review.getReviewId()}|}" class="btn btn-sm"
                               th:if="${#authorization.expression('hasAuthority(''ADMIN'')') or review.getLoginId() != null
                               and #authentication.getName() == review.getLoginId()}">
                                <i class="fa-solid fa-trash"></i> 삭제 </a>
                            <!--삭제 버튼 끝-->
                        </div>

                        <div class="mt-5" th:text="${review.getContent()}" style="white-space: pre-line;"></div> <!--리뷰 개행 값 넣어줌 -->

                        <hr>

                    </div>
                </div>
                <!--페이징 처리-->
                <div th:if="${!reviews.isEmpty()}">
                    <div  class="join flex justify-center mt-5">
                        <a class="join-item btn " th:classappend="${!reviews.hasPrevious} ? 'btn-disabled'"
                           th:href="@{|?page=${nowPage - 1}|}">« </a> <!-- 이전페이지 -->

                        <a th:each="page:${#numbers.sequence(startPage , endPage)}"
                           th:classappend="${page == nowPage} ? 'btn-active'" class="join-item btn "
                           th:text="${page}"  th:href="@{|?page=${page}|}"> </a> <!--현재 페이지-->

                        <a class="join-item btn " th:classappend="${!reviews.hasNext} ? 'btn-disabled'"
                           th:href="@{|?page=${nowPage + 1}|}">» </a> <!-- 다음페이지 -->
                    </div>
                </div>
                <!--페이징 처리 끝-->

            </div>
            <!--리뷰작성 탭 끝 -->


            <input type="radio" name="my_tabs_2" role="tab" class="tab" aria-label="장소" />
            <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6 !block invisible">

                    <!-- 지도 -->
                    <div id="map" style="width: 500px; height: 400px;"></div>

            </div>

        </div>
        <!-------------------여기 까지 컨텐츠 영역-------------------------------------->
    </div>
    <!---------------------------------------여기 까지 phone-6-------------------------->

</div>



<div layout:fragment="script">
    <script th:inline="javascript">

        // 리뷰 작성 유효성 검사 체크
        function submitWriteForm(form) {
            const inputBody = form.content;

            inputBody.value = inputBody.value.trim();

            const body = inputBody.value;

            if (body.length == 0) {
                alert('내용을 입력해주세요.');
                inputBody.focus();

                return;
            }

            form.submit();
        } //여기까지 리뷰 작성 유효성 검사 체크


        window.onload = function() {
            var errorMessage = /*[[${errorMessage}]]*/ null;
            if (errorMessage) {
                alert(errorMessage);
            }
        };

        document.getElementById('submitButton').addEventListener('click', function(event) {
            if (!submitConcertDate(document.getElementById('seatForm'))) {
                event.preventDefault();
            }
        });

        function submitConcertDate(form) {
            var concertDateSelectElement = document.getElementById('concertDateSelect');
            var concertDateId = concertDateSelectElement.options[concertDateSelectElement.selectedIndex].value;

            if (concertDateId.length == 0 || concertDateId == 0) {
                alert('날짜를 선택해주세요.');
                return false;
            }

            form.concertDateId.value = concertDateId;
            return true;
        }

        /**
         * 여기서 부터 리뷰 수정
         * 모달박스에 리뷰내용을 가지고온다.
         */
        function openEditModal(btn) {
            const modal = document.getElementById('edit-review-modal');
            const reviewId = btn.getAttribute('data-review-id');
            const content = btn.getAttribute('data-review-content');
            const concertId = btn.getAttribute('data-concert-id');

            document.getElementById('edit-review').value = content;
            document.getElementById('edit-review-id').value = reviewId;
            document.getElementById('edit-review-concert-id').value = concertId;

            modal.style.display = 'block';
        }

        {
            /**
             * 수정 내용 + csrf 토큰 전송
             */
            const reviewUpdateBtn = document.getElementById("edit-Review-btn");

            // 클릭 이벤트 처리
            reviewUpdateBtn.addEventListener("click", function() {
                const csrfTokenHeaderName = document.querySelector("meta[name='_csrf_header']").getAttribute("content");
                const csrfTokenValue = document.querySelector("meta[name='_csrf']").getAttribute("content");
                // 수정 댓글 객체 생성
                const review = {
                    id: document.querySelector("#edit-review-id").value,
                    content: document.querySelector("#edit-review").value,
                    concert_id: document.querySelector("#edit-review-concert-id").value

                };
                console.log(review);

                const url = "/review/update/" + review.id
                fetch(url, {
                    method: "PATCH", // PATCH 요청
                    headers: {
                        "Content-Type": "application/json",
                        [csrfTokenHeaderName]: csrfTokenValue
                    },
                    body: JSON.stringify(review) //comment 객체를 JSON 문자열로 변환 전송
                }).then(response => {
                    // HTTP 응답 코드에 따른 메시지 출력
                    const msg = (response.ok) ? "리뷰가 수정되었습니다." : "리뷰 수정 실패..!";
                    alert(msg);
                    // 현재 페이지 새로 고침
                    // window.location.reload();
                });
            });

            /**
             *  여기서부터 예매하기 버튼 비 활성화
             */
            const releaseTimeText = document.getElementById('releaseTime').textContent;
            const releaseTime = new Date(releaseTimeText); //시간 포맷

            const  submitButton = document.getElementById('submitButton');

            setInterval(function() {

                const  currentTime = new Date(); // 현재 시간

                if (releaseTime <= currentTime) {  //현재시간이 티켓오픈시간 이 같거나 지난 경우
                    submitButton.disabled = false; //버튼을 활성화


                } else {
                    submitButton.disabled = true; //버튼 비활성화
                    submitButton.textContent = '예매 가능한 시간이 아닙니다';

                }
            }, 1000); // 1초마다 업데이트

            const latitude = /*[[${place.latitude}]]*/ null;
            const longitude = /*[[${place.longitude}]]*/ null;

            var container = document.getElementById('map');
            var options = {
                center: new kakao.maps.LatLng(latitude, longitude),
                level: 3
            };

            var map = new kakao.maps.Map(container, options);

            //탭 메뉴의 블록 처리를 원복
            setTimeout(function () {
                document
                    .querySelectorAll(".tab-content")
                    .forEach((el) => el.classList.remove("!block", "invisible"));
            }, 100);
        }

    </script>

</div>


</html>

